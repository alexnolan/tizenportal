<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TizenPortal 0554</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #fff; 
            font-family: "Segoe UI", -apple-system, sans-serif; 
            margin: 0; 
            padding: 50px 60px; 
            min-height: 100vh;
            overflow-x: hidden;
        }
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding-bottom: 30px; 
            margin-bottom: 40px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        h1 { 
            margin: 0; 
            font-weight: 200; 
            letter-spacing: 4px; 
            font-size: 42px;
            background: linear-gradient(90deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 40px rgba(255,215,0,0.3);
        }
        h1 span {
            font-size: 14px;
            letter-spacing: 1px;
            background: none;
            -webkit-text-fill-color: #666;
        }
        .subtitle {
            color: #666;
            font-size: 14px;
            font-weight: 300;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); 
            gap: 35px;
            padding-bottom: 60px;
        }
        .card { 
            background: linear-gradient(145deg, #1e1e2f 0%, #151525 100%);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border: 2px solid rgba(255,255,255,0.05);
            border-radius: 16px; 
            font-weight: 500; 
            font-size: 18px; 
            flex-direction: column; 
            gap: 15px; 
            cursor: pointer; 
            opacity: 0.8;
            transition: all 0.2s ease;
            overflow: hidden;
            position: relative;
            aspect-ratio: 16/10;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, rgba(255,215,0,0.3), transparent);
            opacity: 0;
            transition: opacity 0.2s;
        }
        .card span {
            color: #ccc;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            padding: 0 15px;
            text-align: center;
        }
        .icon-box { 
            width: 80px; 
            height: 80px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            overflow: hidden;
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .icon-box img { 
            width: 48px; 
            height: 48px; 
            object-fit: contain; 
            display: block;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        .icon-box i { 
            font-size: 40px; 
            color: #888; 
            display: none;
            transition: color 0.2s;
        }
        .card.active, .card:focus { 
            border-color: #FFD700;
            background: linear-gradient(145deg, #2a2a40 0%, #1e1e30 100%);
            opacity: 1; 
            transform: scale(1.08); 
            z-index: 10; 
            box-shadow: 0 8px 40px rgba(255,215,0,0.25), 0 0 60px rgba(255,215,0,0.1);
            outline: none;
        }
        .card.active::before, .card:focus::before {
            opacity: 1;
            background: linear-gradient(90deg, transparent, #FFD700, transparent);
        }
        .card.active .icon-box, .card:focus .icon-box {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255,215,0,0.2);
        }
        .card.active span, .card:focus span {
            color: #fff;
        }
        .card.active .icon-box i, .card:focus .icon-box i {
            color: #FFD700;
        }
        .add { 
            border: 2px dashed rgba(255,255,255,0.15);
            background: transparent;
        }
        .add .icon-box {
            background: rgba(255,255,255,0.03);
            border: 2px dashed rgba(255,255,255,0.1);
        }
        .add span { color: #555; }
        .add.active, .add:focus { 
            border-color: #FFD700;
            background: rgba(255,215,0,0.05);
        }
        .add.active span, .add:focus span { color: #FFD700; }
        
        .card.danger { border-color: rgba(200,50,50,0.3); }
        .card.danger .icon-box { background: rgba(200,50,50,0.1); }
        .card.danger.active, .card.danger:focus { 
            border-color: #c83232;
            box-shadow: 0 8px 40px rgba(200,50,50,0.25);
        }
        .card.danger.active .icon-box i, .card.danger:focus .icon-box i { color: #ff4444; }
        
        #modal { 
            display: none; 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0,0,0,0.9);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            align-items: center; 
            justify-content: center; 
            z-index: 100;
        }
        .box { 
            background: linear-gradient(145deg, #1e1e2f 0%, #151525 100%);
            padding: 50px; 
            width: 550px;
            max-width: 90%;
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.5);
        }
        .box h2 {
            margin: 0 0 10px 0;
            font-weight: 300;
            font-size: 28px;
            color: #FFD700;
            letter-spacing: 1px;
        }
        input, select { 
            padding: 18px 20px; 
            background: rgba(0,0,0,0.3);
            color: white; 
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            width: 100%; 
            font-size: 16px;
            transition: all 0.2s;
        }
        input:focus, select:focus { 
            border-color: #FFD700;
            background: rgba(255,215,0,0.05);
            outline: none;
            box-shadow: 0 0 20px rgba(255,215,0,0.1);
        }
        input::placeholder { color: #666; }
        select option { background: #1a1a2e; color: #fff; }
        .btn-row { display: flex; gap: 15px; margin-top: 15px; }
        button { 
            flex: 1; 
            padding: 18px 24px; 
            background: rgba(255,255,255,0.1);
            color: white; 
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            font-size: 16px; 
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.5px;
        }
        button:hover, button:focus {
            background: rgba(255,255,255,0.15);
            border-color: rgba(255,255,255,0.2);
            outline: none;
        }
        button.primary { 
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #000;
            border: none;
            font-weight: 700;
        }
        button.primary:hover, button.primary:focus {
            box-shadow: 0 0 30px rgba(255,215,0,0.4);
            transform: translateY(-2px);
        }
        #btn-delete {
            background: rgba(200,50,50,0.2);
            border: 1px solid rgba(200,50,50,0.3);
            color: #ff6666;
        }
        #btn-delete:hover, #btn-delete:focus {
            background: rgba(200,50,50,0.3);
            border-color: #c83232;
        }
        #toast { 
            position: fixed; 
            bottom: 40px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: rgba(30,30,50,0.95);
            border: 1px solid rgba(255,215,0,0.3);
            padding: 15px 30px; 
            border-radius: 30px;
            font-size: 14px;
            letter-spacing: 0.5px;
            opacity: 0; 
            transition: opacity 0.5s; 
            pointer-events: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .hint {
            position: fixed;
            bottom: 40px;
            right: 60px;
            display: flex;
            gap: 20px;
            color: #555;
            font-size: 13px;
        }
        .hint-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .hint-key {
            background: rgba(255,255,255,0.1);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            color: #888;
            border: 1px solid rgba(255,255,255,0.1);
        }
        /* Hide template scripts - old browsers may render them */
        script[type="text/template"] { display: none !important; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <header>
        <div>
            <h1>TizenPortal <span>0559</span></h1>
            <div class="subtitle">Smart TV App Launcher</div>
        </div>
    </header>
    <div id="grid" class="grid"></div>
    <div id="toast">Long Press Enter to Edit</div>
    <div class="hint">
        <div class="hint-item"><span class="hint-key">ENTER</span> Launch</div>
        <div class="hint-item"><span class="hint-key">HOLD</span> Edit</div>
    </div>
    <div id="debug-status" style="position:fixed;top:0;right:0;background:#000;color:#0f0;padding:10px;font-size:12px;font-family:monospace;z-index:9999;border:1px solid #0f0;display:none;">Loading...</div>
    <div id="modal">
        <div class="box">
            <h2 id="modal-title">Add App</h2>
            <input type="text" id="name" placeholder="App Name">
            <input type="url" id="url" placeholder="App URL">
            <select id="preset"><option value="">-- No Preset --</option></select>
            <select id="ua"></select>
            <div class="btn-row"><button onclick="closeModal()">Cancel</button><button onclick="save()" class="primary">Save</button></div>
            <button id="btn-delete" onclick="deleteApp()" style="margin-top:10px; display:none;">Delete App</button>
        </div>
    </div>

    <script id="abs-css" type="text/template">
body {background-color:#222 !important;margin:0 !important;padding:20px !important;overflow-y:auto !important;font-family:sans-serif !important;color:#fff !important;} .tp-lifeboat-active #app-content,.tp-lifeboat-active #__nuxt {opacity:0.001 !important;pointer-events:none !important;position:fixed !important;top:0 !important;left:0 !important;z-index:-100 !important;} .tp-lifeboat-active [role="toolbar"][aria-label="Library Sidebar"],.tp-lifeboat-active [role="toolbar"][aria-label="Appbar"],.tp-lifeboat-active [role="dialog"],.tp-lifeboat-active .modal,.tp-lifeboat-active .Vue-Toastification__container,.tp-lifeboat-active [style*="bottom:65px"] {display:none !important;} #tp-lifeboat {display:none;width:calc(100% - 120px);padding:20px;padding-bottom:50px;margin-top:60px;margin-left:100px;} .tp-lifeboat-active #tp-lifeboat {display:block;} #tp-navbar {position:fixed;top:50px;left:0;bottom:0;width:90px;background:rgba(0,0,0,0.95);border-right:2px solid #b8860b;display:flex;flex-direction:column;align-items:center;padding:15px 5px;z-index:10000;box-shadow:5px 0 15px rgba(0,0,0,0.5);overflow-y:auto;} .tp-nav-item {color:#ddd;font-size:12px;text-align:center;cursor:pointer;padding:12px 8px;margin-bottom:5px;border:1px solid transparent;border-radius:6px;white-space:normal;width:100%;} .tp-nav-item:focus,.tp-nav-item:hover {color:#FFD700;border-color:#FFD700;background:#333;outline:none;} #tp-menu {position:fixed;right:0;top:50px;bottom:0;width:350px;background:#1a3a52;border-left:3px solid #1e90ff;z-index:9999;display:none;flex-direction:column;box-shadow:-10px 0 30px rgba(0,0,0,0.7);} #tp-menu.active {display:flex;} #tp-menu-header {background:#0f2847;color:#1e90ff;padding:15px;border-bottom:2px solid #1e90ff;font-weight:bold;font-size:16px;} #tp-menu-list {flex-shrink:0;overflow-y:auto;max-height:40%;border-bottom:1px solid #0f2847;} .tp-menu-item {padding:12px 15px;color:#aaa;cursor:pointer;border-bottom:1px solid #0f2847;font-size:14px;transition:background 0.1s;} .tp-menu-item:focus,.tp-menu-item.active {color:#1e90ff;background:#0f2847;outline:3px solid #1e90ff;font-weight:bold;} #tp-menu-content {flex:1;overflow-y:auto;padding:15px;} img[alt="Home"] {max-width:50px !important;height:auto !important;} .tp-rescued-card img {width:100% !important;height:200px !important;object-fit:cover !important;display:block !important;max-width:none !important;}
    </script>
    
    <script id="abs-js" type="text/template">
var ABS={log:function(e){console.log("[TP ABS] "+e);try{var t=document.getElementById("tp-diag");t||(t=document.createElement("div"),t.id="tp-diag",t.style.cssText="position:fixed;top:60px;left:10px;background:#000;color:#0f0;padding:10px;font-size:14px;z-index:999999;border:2px solid #0f0;max-width:400px;",document.body.appendChild(t));t.textContent="[ABS] "+e}catch(e){}},init:function(){this.log("v0559 INIT");setTimeout(function(){ABS.log("Step 1: body ready");},500);setTimeout(function(){ABS.log("Step 2: checking DOM...");try{var n=document.querySelectorAll('[id^="book-card-"]');ABS.log("Found "+n.length+" book cards");}catch(e){ABS.log("ERROR: "+e.message);}},1500);}};ABS.init();
    </script>

    <script>
        var PRESETS = {
            "__CORE__": {
                "css": "html{width:1920px!important;margin:0 auto!important}body{background-size:cover!important;background-position:center!important;background-attachment:fixed!important;background-repeat:no-repeat!important;margin:0!important;padding:20px!important;overflow-y:auto!important}*{-webkit-appearance:none!important}img,svg,video{max-width:100%!important;height:auto!important;box-sizing:border-box!important}img[width]{width:auto!important;max-width:100%!important}img[height]{height:auto!important}img[src]{max-width:100%!important;height:auto!important}svg{max-width:100%!important}img.w-4,img.w-6,img.w-8,img.h-4,img.h-6,img.h-8,img.h-10,img.w-10,img.min-w-0,img.min-h-0{width:auto!important;height:auto!important;max-width:50px!important;min-width:auto!important;min-height:auto!important}img[class*=\"w-\"],img[class*=\"h-\"],img[class*=\"min-w\"],img[class*=\"min-h\"],img[class*=\"max-w\"],img[class*=\"max-h\"]{width:auto!important;height:auto!important;max-width:50px!important;min-width:auto!important;min-height:auto!important;max-height:auto!important}button img,a img,nav img,[role=\"navigation\"] img,aside img,.tp-nav-item img{max-width:50px!important;height:auto!important}#tp-proxy-form img,#tp-lifeboat img{max-width:200px!important;height:auto!important;display:block!important}.tp-rescued-card img{width:100%!important;height:160px!important;object-fit:cover!important;display:block!important}:focus{outline:5px solid #FFD700!important}::-webkit-scrollbar{display:none}#tp-proxy-form{background:#222;border:2px solid #FFD700;padding:24px;max-width:420px;margin:60px auto;border-radius:10px;text-align:center;box-shadow:0 0 20px rgba(0,0,0,0.6)}.tp-input{display:block;width:92%;margin:12px auto;padding:12px;font-size:18px;background:#fff;color:#000;border:none;border-radius:5px}.tp-btn{display:block;width:92%;margin:16px auto;padding:12px;font-size:18px;background:#FFD700;color:#000;font-weight:bold;cursor:pointer;border:none;border-radius:5px}.tp-btn:focus,.tp-input:focus{outline:3px solid #fff}.tp-shelf-title{color:#FFD700!important;font-size:24px!important;font-weight:bold;text-shadow:2px 2px 4px #000;border-bottom:2px solid #FFD700;padding:10px;margin-top:40px;margin-bottom:15px;clear:both;background:rgba(0,0,0,0.4);border-radius:5px}.tp-rescued-card{display:inline-block!important;width:160px!important;min-height:240px!important;margin:15px!important;vertical-align:top!important;position:relative!important;cursor:pointer!important;background:rgba(0,0,0,0.5)!important;box-shadow:3px 3px 10px rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.1);transition:transform 0.1s;transform:translateZ(0)}.tp-rescued-card p,.tp-rescued-card span,.tp-rescued-card div{color:#fff!important;text-shadow:1px 1px 2px #000!important;font-size:13px!important;line-height:1.2!important;background:transparent!important;margin:0!important;padding:3px!important;overflow:hidden!important;text-overflow:ellipsis!important;display:block!important;max-width:100%!important}.tp-rescued-card *{word-break:break-word!important;white-space:normal!important}.tp-rescued-card:focus{outline:4px solid #FFD700!important;transform:scale(1.1) translateZ(0);z-index:5000;background:#000!important}",
                "js": "if(!Element.prototype.closest){Element.prototype.closest=function(s){var el=this;do{if(el.matches(s))return el;el=el.parentElement||el.parentNode}while(el!==null&&el.nodeType===1);return null}}window.TizenUtils={keepAwake:function(){try{var v=document.createElement('video');v.src='https://raw.githubusercontent.com/anthonium/Gestures/master/blank.mp4';v.loop=true;v.play();document.body.appendChild(v)}catch(e){}},lockViewport:function(){var meta=document.querySelector('meta[name=\"viewport\"]');if(!meta){meta=document.createElement('meta');meta.name='viewport';document.head.appendChild(meta)}meta.setAttribute('content','width=1920, initial-scale=1, maximum-scale=1, user-scalable=no');},getParam:function(n){var r=new RegExp('[\\?&]'+n+'=([^&#]*)').exec(location.search);return r===null?'':decodeURIComponent(r[1])},navigate:function(u){if(!u)return;var t=this.getParam('tp');if(t&&u.indexOf('tp=')===-1)u+=(u.indexOf('?')>-1?'&':'?')+'tp='+t;window.location.href=u},handleLogin:function(cont,title){var isVis=function(e){return e&&e.offsetParent!==null&&e.style.display!=='none'&&e.style.visibility!=='hidden'};var inputs=document.querySelectorAll('input,textarea,select,button');var hasVis=false;for(var k=0;k<inputs.length;k++){if(isVis(inputs[k])){hasVis=true;break}}if(!hasVis){if(!p)return false;else return true;}var p=document.getElementById('tp-proxy-form');if(!p){p=document.createElement('div');p.id='tp-proxy-form';p.style.marginBottom='30px';p.style.borderBottom='2px solid #333';if(cont){if(cont.firstChild)cont.insertBefore(p,cont.firstChild);else cont.appendChild(p)}}var els=document.querySelectorAll('input,textarea,select,button');for(var i=0;i<els.length;i++){var o=els[i];if(!isVis(o)||o.hasAttribute('data-tp-pxy'))continue;o.setAttribute('data-tp-pxy','1');var wrapper=document.createElement('div');wrapper.style.margin='10px 0';if(o.tagName==='BUTTON'||(o.tagName==='INPUT'&&(o.type==='submit'||o.type==='button'))){var b=document.createElement('button');b.innerText=o.innerText||o.value||'Submit';b.className='tp-btn';b.tabIndex=0;b.onclick=function(orig){return function(){orig.click()}}(o);wrapper.appendChild(b)}else{var n=document.createElement(o.tagName==='TEXTAREA'?'textarea':'input');if(o.tagName==='INPUT')n.type=o.type;n.className='tp-input';n.placeholder=o.placeholder||o.name||'';n.value=o.value;n.tabIndex=0;(function(orig,pxy){pxy.oninput=function(){orig.value=pxy.value;orig.dispatchEvent(new Event('input'));orig.dispatchEvent(new Event('change'))};pxy.onkeydown=function(e){if(e.keyCode===38||e.keyCode===40){e.preventDefault();var all=Array.prototype.slice.call(document.querySelectorAll('#tp-proxy-form .tp-input, #tp-proxy-form .tp-btn'));var idx=all.indexOf(pxy);if(e.keyCode===38&&idx>0)all[idx-1].focus();if(e.keyCode===40&&idx<all.length-1)all[idx+1].focus()}if(e.keyCode===10009||e.keyCode===27){e.preventDefault();pxy.blur()}if(e.keyCode===13&&orig.form){var s=orig.form.querySelector('button[type=\"submit\"]');if(s)s.click()}}})(o,n);wrapper.appendChild(n)}p.appendChild(wrapper)}return p&&p.childElementCount>0}};TizenUtils.lockViewport();TizenUtils.keepAwake();"
            },
            "abs": { "name": "Audiobookshelf", "css": "", "js": "" },
            "jellyfin": { "name": "Jellyfin", "css": ":focus-visible{outline:4px solid #FFD700!important}", "js": "" }
        };
        
        var USER_AGENTS = [
            { id: "default", name: "Tizen (Default)", str: null },
            { id: "mobile",  name: "Mobile (Android)", str: "Mozilla/5.0 (Linux; Android 10; Mobile) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.162 Mobile Safari/537.36" },
            { id: "desktop", name: "Desktop (PC)",     str: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36" }
        ];
        
        var apps = JSON.parse(localStorage.getItem('tp_apps') || '[]');
        var selectedIndex = 0; var editIndex = -1; var pressTimer = null;

        function init() {
            function dbg(msg) { 
                document.getElementById('debug-status').textContent = msg; 
                console.log(msg);
            }
            dbg('init: loading presets...');
            try {
                var absCss = document.getElementById('abs-css');
                var absJs = document.getElementById('abs-js');
                if (!absCss) throw new Error('abs-css template not found');
                if (!absJs) throw new Error('abs-js template not found');
                PRESETS.abs.css = absCss.innerHTML;
                PRESETS.abs.js = absJs.innerHTML;
                dbg('init: presets loaded (css=' + Math.round(PRESETS.abs.css.length/1024) + 'KB, js=' + Math.round(PRESETS.abs.js.length/1024) + 'KB)');
            } catch(e) {
                dbg('init: preset error: ' + (e.message || 'unknown'));
                console.error('[TP] Error loading presets:', e);
            }

            if (typeof tizen !== 'undefined' && tizen.tvinputdevice) {
                var keys = ["ColorF0Red", "ColorF1Green", "ColorF2Yellow", "ColorF3Blue", "MediaPlay", "MediaPause"];
                for (var i = 0; i < keys.length; i++) { try { tizen.tvinputdevice.registerKey(keys[i]); } catch(e){} }
            }
            dbg('init: building UI...');
            var selP = document.getElementById('preset'); Object.keys(PRESETS).forEach(function(k) { if(k!=='__CORE__') selP.innerHTML+='<option value="'+k+'">'+PRESETS[k].name+'</option>'; });
            var selU = document.getElementById('ua'); USER_AGENTS.forEach(function(u) { selU.innerHTML+='<option value="'+u.id+'">'+u.name+'</option>'; });
            dbg('init: rendering grid...');
            render(); 
            dbg('init: done!');
            showToast("Long Press Enter to Edit"); 
            setInterval(enforceFocus, 200);
        }

        function getIconClass(name) {
            var n = name.toLowerCase();
            if(n.indexOf('home')>-1 || n.indexOf('ha')>-1) return 'fa-home';
            if(n.indexOf('jelly')>-1 || n.indexOf('play')>-1 || n.indexOf('tube')>-1) return 'fa-play-circle';
            if(n.indexOf('book')>-1 || n.indexOf('read')>-1 || n.indexOf('abs')>-1) return 'fa-book';
            return 'fa-globe';
        }

        function render() {
            var g = document.getElementById('grid'); g.innerHTML = '';
            apps.forEach(function(a, i) {
                var d = document.createElement('div'); d.className = 'card'; d.tabIndex = 0;
                var iconClass = getIconClass(a.name);
                var imgHTML = '<img src="https://s2.googleusercontent.com/s2/favicons?domain_url='+encodeURIComponent(a.url)+'&sz=64" onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'block\';">';
                var iconHTML = '<i class="fas '+iconClass+'"></i>';
                var box = '<div class="icon-box">' + imgHTML + iconHTML + '</div>';
                d.innerHTML = box + '<span>'+a.name+'</span>';
                // Note: onclick removed - launch/edit handled by global keydown/keyup with long-press detection
                g.appendChild(d);
            });
            
            var clear = document.createElement('div'); clear.className = 'card danger'; clear.tabIndex = 0;
            clear.innerHTML = '<div class="icon-box"><i class="fas fa-trash-alt" style="display:block;color:#a00"></i></div><span style="color:#a00">Clear Cache</span>';
            clear.onclick = function() { clearCache(); };
            clear.onkeydown = function(e) { if(e.keyCode===13) clearCache(); };
            g.appendChild(clear);

            var add = document.createElement('div'); add.className = 'card add'; add.tabIndex = 0;
            add.innerHTML = '<i class="fas fa-plus"></i><span>Add App</span>'; g.appendChild(add);
            updateSelection();
        }

        function clearCache() {
            if(confirm("Clear all cached data (TP Config)?")) {
                localStorage.removeItem('tp_conf');
                sessionStorage.removeItem('tp_conf');
                window.location.reload();
            }
        }

        function updateSelection() {
            var cards = document.querySelectorAll('.card');
            if (selectedIndex >= cards.length) selectedIndex = cards.length - 1;
            if (selectedIndex < 0) selectedIndex = 0;
            for (var i = 0; i < cards.length; i++) { if (i === selectedIndex) { cards[i].classList.add('active'); cards[i].focus(); } else { cards[i].classList.remove('active'); } }
        }
        function enforceFocus() { if(document.getElementById('modal').style.display === 'flex') return; var cards = document.querySelectorAll('.card'); if(cards[selectedIndex] && document.activeElement !== cards[selectedIndex]) cards[selectedIndex].focus(); }

        document.addEventListener('keydown', function(e) {
            var k = e.keyCode;
            var modal = document.getElementById('modal');
            if(modal.style.display === 'flex') { 
                // Handle text field navigation and break-out in modal
                var isTextInput = (document.activeElement && ((document.activeElement.tagName === 'INPUT' && document.activeElement.type !== 'button' && document.activeElement.type !== 'submit') || document.activeElement.tagName === 'TEXTAREA'));
                if (isTextInput) {
                    if (k === 10009 || k === 27) { document.activeElement.blur(); e.preventDefault(); return; }
                    if (k === 38 || k === 40) {
                        var inputs = Array.prototype.slice.call(modal.querySelectorAll('input, textarea, button, select'));
                        var idx = inputs.indexOf(document.activeElement);
                        if (k === 38 && idx > 0) { inputs[idx-1].focus(); e.preventDefault(); }
                        if (k === 40 && idx < inputs.length - 1) { inputs[idx+1].focus(); e.preventDefault(); }
                        return;
                    }
                    return; // Allow left/right editing
                }
                if (k === 10009 || k === 27) { closeModal(); return; }
                return;
            }
            var cols = Math.floor(document.getElementById('grid').offsetWidth / 250) || 3;
            if (k===37) selectedIndex--; if (k===39) selectedIndex++; if (k===38) selectedIndex-=cols; if (k===40) selectedIndex+=cols; 
            if ([37,38,39,40].indexOf(k) > -1) { e.preventDefault(); updateSelection(); }
            if (k===13 && !pressTimer) { pressTimer = setTimeout(function() { pressTimer=null; openModal(selectedIndex); }, 800); }
        });
        document.addEventListener('keyup', function(e) { 
            if (e.keyCode === 13) { 
                if (pressTimer) { 
                    clearTimeout(pressTimer); 
                    pressTimer = null; 
                    var cards = document.querySelectorAll('.card');
                    var addIdx = cards.length - 1;  // Add App is last card
                    var clearIdx = cards.length - 2; // Clear Cache is second to last
                    if (selectedIndex === addIdx) {
                        openModal(-1); // Add new app
                    } else if (selectedIndex === clearIdx) {
                        clearCache(); // Clear cache
                    } else if (apps[selectedIndex]) {
                        launch(apps[selectedIndex]); // Launch existing app
                    }
                } 
            } 
        });

        function launch(app) {
            var dbg = document.getElementById('debug-status');
            dbg.style.display = 'block';
            try {
                dbg.textContent = 'launch: ' + app.name + ' preset=' + (app.presetID || 'none');
                var core = PRESETS['__CORE__']; 
                var preset = PRESETS[app.presetID] || {}; 
                dbg.textContent = 'preset css=' + (preset.css ? preset.css.length : 0) + ' js=' + (preset.js ? preset.js.length : 0);
                var uaObj = USER_AGENTS.find(function(u){ return u.id === app.ua }) || USER_AGENTS[0];
                var payload = { css: (core.css||'')+'\n'+(preset.css||''), js: (core.js||'')+'\n'+(preset.js||''), ua: uaObj.str };
                var json = JSON.stringify(payload);
                dbg.textContent = 'json=' + json.length + ' chars, wn=' + json.length;
                // Use window.name for payload delivery (survives cross-origin navigation, no URL limits)
                window.name = 'TP:' + json;
                dbg.textContent = 'GO: ' + app.url;
                // Force navigation with setTimeout to ensure UI updates
                setTimeout(function() {
                    window.location.href = app.url;
                }, 100);
            } catch(e) {
                dbg.textContent = 'ERROR: ' + (e.message || 'unknown');
                console.error('[TP] Launch error:', e);
                alert('Error launching app: ' + (e.message || 'unknown'));
            }
        }

        function openModal(index) { 
            editIndex = index; var isAdd = (index === -1 || index >= apps.length);
            document.getElementById('modal-title').innerText = isAdd ? "Add App" : "Edit App"; document.getElementById('btn-delete').style.display = isAdd ? 'none' : 'block';
            if (!isAdd) { var a = apps[index]; document.getElementById('name').value = a.name; document.getElementById('url').value = a.url; document.getElementById('preset').value = a.presetID || ""; document.getElementById('ua').value = a.ua || "default"; } 
            else { document.getElementById('name').value = ""; document.getElementById('url').value = ""; }
            document.getElementById('modal').style.display='flex'; document.getElementById('name').focus(); 
        }
        function closeModal() { document.getElementById('modal').style.display='none'; }
        function save() {
            var name=document.getElementById('name').value; var url=document.getElementById('url').value;
            if(name && url) { var appObj = {name:name, url:url, presetID:document.getElementById('preset').value, ua:document.getElementById('ua').value}; if (editIndex > -1 && editIndex < apps.length) apps[editIndex] = appObj; else { apps.push(appObj); selectedIndex = apps.length-1; } localStorage.setItem('tp_apps', JSON.stringify(apps)); closeModal(); render(); }
        }
        function deleteApp() { if(editIndex > -1 && confirm("Delete?")) { apps.splice(editIndex, 1); localStorage.setItem('tp_apps', JSON.stringify(apps)); selectedIndex=Math.max(0,editIndex-1); closeModal(); render(); } }
        function showToast(msg) { var t=document.getElementById('toast'); t.innerText=msg; t.style.opacity=1; setTimeout(function(){t.style.opacity=0;},5000); }
        init();
    </script>
</body>
</html>
